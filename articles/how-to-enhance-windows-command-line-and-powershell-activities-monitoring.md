---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# How to enhance Windows command-line and PowerShell  activities monitoring

As organizations increasingly rely on automation and scripting tools like PowerShell for management and administration, it is crucial to improve visibility into the activities occurring within Windows command-line environments. Malicious actors often leverage PowerShell and command-line utilities to execute commands, escalate privileges, and conduct reconnaissance within networks.

In this article I want to briefly discuss the most common ways to review these activities in Sentinel and two proposals to improve its monitoring capabilities.

### Where we usually can find Command-Line and PowerShell Activities in Sentinel? 🔍

**SecurityEvent**: This table contains logs from Windows Security Events, which include PowerShell execution events, especially when PowerShell is launched with specific command-line arguments. You can query this table for processes like `powershell.exe` to track when PowerShell is executed and check the command lines for potentially suspicious activity.

Example query for PowerShell activity:

```
SecurityEvent
| where FileName == "powershell.exe" or NewProcessName endswith "powershell.exe"
| where CommandLine contains "powershell"
```

**DeviceProcessEvents**: This table tracks process activity on devices. You can use this table to monitor the full command-line details for processes, including PowerShell executions, helping to track which commands are being executed across endpoints.

Example query for process creation involving PowerShell:

```
DeviceProcessEvents
| where FileName has "powershell.exe" 
| where ProcessCommandLine has "powershell"
```

### Bring out the big guns! 💣

#### Event ID 4104 for Script Block Logging

By default, PowerShell logs activity in the **Applications and Services Logs** under `Microsoft > Windows > PowerShell > Operational`. However, this logging is limited unless **PowerShell Script Block Logging** is enabled. This feature can log the full content of executed PowerShell scripts, including obfuscated or dynamically generated code, which is vital for detecting malicious activity.

Here's how you can enable and utilize this logging:

1\. Open the **Local Group Policy Editor**.

2\. Navigate to: **Computer Configuration > Administrative Templates > Windows Components > Windows PowerShell**.

3\. Enable the policy: **Turn on PowerShell Script Block Logging**.

<figure><img src="../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

Once enabled, the logs are stored in **Event Viewer** under **Applications and Services Logs > Microsoft > Windows > PowerShell > Operational**.

The event ID to focus on is **4104**. This event contains the full PowerShell script block executed, including user/domain information, timestamp, host, and the exact script content.

#### Sysmon for enhanced monitoring

While PowerShell Script Block Logging is a powerful tool, you can further improve visibility into command-line activities by integrating **Sysmon** (System Monitor). Sysmon is a free utility that logs system activity to the Windows Event Log. It provides detailed process creation logs, including full command lines and parent-child relationships, which can help detect malicious activities involving command-line tools.

{% hint style="info" %}
Sysmon official documentation on [Microsoft](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon)
{% endhint %}

One of the most useful events generated by Sysmon is **Event ID 1**, which logs the creation of processes, including their full command-line arguments.

Configuration Steps:

**1. Download and Install Sysmon**: Visit the [Sysmon download page](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon) and install it on your system.

**2. Configure Sysmon**: Sysmon can be configured using a configuration file that defines which events to capture. Ensure that **Event ID 1** (process creation) is enabled to log detailed command-line arguments.

**3. Query Sysmon Logs in Sentinel**: Once Sysmon is installed, the generated events can be ingested into Sentinel using a **Sysmon Data Connector**. After the events are ingested, you can query them in the **Event** table by filtering for Sysmon logs:

```
Event
| where Source == "Microsoft-Windows-Sysmon"
| where EventID == 1
| project TimeGenerated, ProcessCommandLine, DeviceName, AccountName
```

#### Final Steps: Data Connectors and Analytic Rules

Once you’ve enabled PowerShell Script Block Logging and installed Sysmon, the next step is to configure **data connectors** in Azure Sentinel to ingest Windows Security and Sysmon logs. These logs provide a wealth of data that can be used to detect suspicious activity, including command-line execution.

After configuring the connectors, create **analytic rules** in Sentinel to monitor for patterns associated with malicious PowerShell commands or abnormal process creation. For example, you can configure Sentinel to alert you when PowerShell scripts are being executed with suspicious arguments, or when Sysmon logs show unusual process activity.

### References:

[Set up PowerShell script block logging for added security](https://www.techtarget.com/searchwindowsserver/tutorial/Set-up-PowerShell-script-block-logging-for-added-security)

[Using Sysmon in Azure Sentinel](https://medium.com/blueteamlabs/using-sysmon-in-azure-sentinel-883eb6ffc431)

[Sysmon v15.15](https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon)
